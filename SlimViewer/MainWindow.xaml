<Window x:Class="SlimViewer.MainWindow"
        x:ClassModifier="internal"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:Images="clr-namespace:CommonControls.Images;assembly=CommonControls.Images"
        xmlns:commonControls="clr-namespace:CommonControls;assembly=CommonControls"
        xmlns:external="clr-namespace:CommonControls;assembly=CommonControls"
        xmlns:local="clr-namespace:SlimViewer"
        xmlns:slimControls="clr-namespace:SlimControls;assembly=SlimControls"
        xmlns:slimviews="clr-namespace:SlimViews;assembly=SlimViews"
        d:DataContext="{d:DesignInstance Type=slimviews:ImageView}"
        mc:Ignorable="d"
        Title="Slim Viewer"
        Height="800" Width="1200"
        Drop="Image_Drop" AllowDrop="True"
        UseLayoutRounding="True" Loaded="Window_Loaded">

    <Grid external:GlobalKeyHandler.Attach="True"
          external:GlobalKeyHandler.SkipTextControls="True"
          external:GlobalKeyHandler.CommandBindings="{Binding CommandBindings}">

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="5" />
            <RowDefinition Height="*" />
            <RowDefinition Height="5" />
            <RowDefinition Height="180" />
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="10" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="10" />
        </Grid.ColumnDefinitions>

        <Grid Grid.Row="0" Grid.Column="1" Margin="0,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="20" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="20" />
                <ColumnDefinition Width="150" />
            </Grid.ColumnDefinitions>

            <Menu Grid.Column="0" VerticalAlignment="Center">
                <MenuItem Header="Menu">
                    <MenuItem Header="Open" Command="{Binding Commands.Open}" InputGestureText="Ctrl+O"
                  ToolTip="Open an image file" />
                    <MenuItem Header="Open Folder" Command="{Binding Commands.Folder}"
                  ToolTip="Open all images in a folder" />
                    <MenuItem Header="Open CBZ" Command="{Binding Commands.OpenCbz}"
                  ToolTip="Open a comic book archive (CBZ)" />
                    <Separator />
                    <MenuItem Header="Search" Command="{Binding Commands.FolderSearch}" InputGestureText="Ctrl+F"
                  ToolTip="Search for files by name or color" />
                    <Separator />
                    <MenuItem Header="Save" Command="{Binding Commands.Save}" IsEnabled="{Binding Path=IsImageActive}"
                  InputGestureText="Ctrl+S" ToolTip="Save the currently active image" />
                    <MenuItem Header="Delete" Command="{Binding Commands.Delete}"
                  IsEnabled="{Binding Path=IsImageActive}" InputGestureText="Del"
                  ToolTip="Delete the current image from disk" />
                    <MenuItem Header="Refresh" Command="{Binding Commands.Refresh}"
                  IsEnabled="{Binding Path=IsImageActive}" InputGestureText="F5"
                  ToolTip="Reload the current image" />
                    <Separator />
                    <MenuItem Header="Close" Command="{Binding Commands.Close}" ToolTip="Close the application" />
                </MenuItem>

                <MenuItem Header="Edit" >
                    <MenuItem Header="Filter">
                        <MenuItem Header="Configure Filter" Command="{Binding Commands.FilterConfig}"
                      ToolTip="Open filter configuration settings" />
                        <Separator />
                        <MenuItem Header="TextureNoise" Command="{Binding Commands.ApplyTexture}" CommandParameter="{x:Static slimControls:ViewGuiResources.TextureNoise}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="TextureClouds" Command="{Binding Commands.ApplyTexture}" CommandParameter="{x:Static slimControls:ViewGuiResources.TextureClouds}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="TextureMarble" Command="{Binding Commands.ApplyTexture}" CommandParameter="{x:Static slimControls:ViewGuiResources.TextureMarble}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="TextureWood" Command="{Binding Commands.ApplyTexture}" CommandParameter="{x:Static slimControls:ViewGuiResources.TextureWood}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="TextureWave" Command="{Binding Commands.ApplyTexture}" CommandParameter="{x:Static slimControls:ViewGuiResources.TextureWave}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="TextureCrosshatch" Command="{Binding Commands.ApplyTexture}" CommandParameter="{x:Static slimControls:ViewGuiResources.TextureCrosshatch}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="TextureConcrete" Command="{Binding Commands.ApplyTexture}" CommandParameter="{x:Static slimControls:ViewGuiResources.TextureConcrete}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="TextureCanvas" Command="{Binding Commands.ApplyTexture}" CommandParameter="{x:Static slimControls:ViewGuiResources.TextureCanvas}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Pixelate">
                            <MenuItem Header="Fine (4px)" Command="{Binding Commands.Pixelate}" CommandParameter="4" 
                          ToolTip="Subtle pixelation." />
                            <MenuItem Header="Medium (8px)" Command="{Binding Commands.Pixelate}" CommandParameter="8" 
                          ToolTip="Standard pixelation." />
                            <MenuItem Header="Chunky (16px)" Command="{Binding Commands.Pixelate}" CommandParameter="16" 
                          ToolTip="Heavy pixelation." />
                            <MenuItem Header="Abstract (32px)" Command="{Binding Commands.Pixelate}" CommandParameter="32" 
                          ToolTip="Mosaic look." />
                        </MenuItem>
                    </MenuItem>

                    <MenuItem Header="Texture">
                        <MenuItem Header="Configure Texture" Command="{Binding Commands.TextureConfig}"
                      ToolTip="Open texture configuration settings" />
                        <Separator />
                        <MenuItem Header="Sepia" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterSepia}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="GrayScale" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterGrayScale}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="BlackAndWhite" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterBlackAndWhite}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Invert" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterInvert}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Polaroid" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterPolaroid}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Contour" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterContour}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Brightness" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterBrightness}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Contrast" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterContrast}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="HueShift" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterHueShift}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="ColorBalance" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterColorBalance}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Vintage" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterVintage}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Sharpen" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterSharpen}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="GaussianBlur" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterGaussianBlur}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Emboss" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterEmboss}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="BoxBlur" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterBoxBlur}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Laplacian" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterLaplacian}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="EdgeEnhance" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterEdgeEnhance}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="MotionBlur" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterMotionBlur}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="UnsharpMask" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterUnsharpMask}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="DifferenceOfGaussians" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterDifferenceOfGaussians}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="Crosshatch" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterCrosshatch}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="FloydSteinbergDithering" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterFloydSteinbergDithering}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="AnisotropicKuwahara" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterAnisotropicKuwahara}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="SupersamplingAntialiasing" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterSupersamplingAntialiasing}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="PostProcessingAntialiasing" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterPostProcessingAntialiasing}" IsEnabled="{Binding Path=IsImageActive}" />
                        <MenuItem Header="PencilSketchEffect" Command="{Binding Commands.ApplyFilter}" CommandParameter="{x:Static slimControls:ViewGuiResources.FilterPencilSketchEffect}" IsEnabled="{Binding Path=IsImageActive}" />
                        <Separator />
                    </MenuItem>

                    <Separator />
                    <MenuItem Header="Mirror" Command="{Binding Commands.Mirror}" IsEnabled="{Binding Path=IsImageActive}"/>
                    <MenuItem Header="Rotate 90°" Command="{Binding Commands.RotateForward}" IsEnabled="{Binding Path=IsImageActive}"/>
                    <MenuItem Header="Rotate -90°" Command="{Binding Commands.RotateBackward}" IsEnabled="{Binding Path=IsImageActive}"/>

                    <Separator />
                    <MenuItem Header="Brighten" Command="{Binding Commands.Brighten}" IsEnabled="{Binding Path=IsImageActive}"/>
                    <MenuItem Header="Darken" Command="{Binding Commands.Darken}" IsEnabled="{Binding Path=IsImageActive}"/>

                    <Separator />
                    <MenuItem Header="Scale Image" Command="{Binding Commands.Scale}" IsEnabled="{Binding Path=IsImageActive}" />
                    <MenuItem Header="Export to String" Command="{Binding Commands.ExportString}" IsEnabled="{Binding Path=IsImageActive}"/>
                </MenuItem>

                <MenuItem Header="Tools">
                    <MenuItem Header="Batch Rename" Command="{Binding Commands.FolderRename}"
                  ToolTip="Rename multiple files at once" />
                    <MenuItem Header="Format Converter" Command="{Binding Commands.FolderConvert}"
                  ToolTip="Convert multiple files to another format" />
                    <MenuItem Header="Mass Resizer" Command="{Binding Commands.ResizerWindow}"
                  ToolTip="Resize all images in a folder" />
                    <Separator />
                    <MenuItem Header="Find Duplicates" Command="{Binding Commands.Duplicate}"
                  ToolTip="Search for exact duplicate images" />
                    <MenuItem Header="Find Similar Images">
                        <MenuItem Header="Near Identical (95%)" Command="{Binding Commands.Similar}" CommandParameter="95" />
                        <MenuItem Header="Highly Similar (90%)" Command="{Binding Commands.Similar}" CommandParameter="90" />
                        <MenuItem Header="Visual Match (80%)" Command="{Binding Commands.Similar}" CommandParameter="80" />
                        <MenuItem Header="Loose Match (70%)" Command="{Binding Commands.Similar}" CommandParameter="70" />
                    </MenuItem>
                    <Separator />
                    <MenuItem Header="Gif Editor" Command="{Binding Commands.GifWindow}" />
                    <MenuItem Header="Image Analyzer" Command="{Binding Commands.AnalyzerWindow}" />
                </MenuItem>

                <MenuItem Header="Experimental">
                    <MenuItem Header="Open Cif" Command="{Binding Commands.OpenCif}" />
                    <MenuItem Header="Convert to Cif" Command="{Binding Commands.ConvertCif}" />
                    <Separator />
                    <MenuItem Header="Compress Cif" 
                  IsCheckable="True" 
                  IsChecked="{Binding Path=CompressCif}" 
                  ToolTip="Enable compression for CIF files" />
                </MenuItem>

                <MenuItem Header="Help">
                    <MenuItem Header="View Help" Command="{Binding Commands.ShowHelp}" InputGestureText="F1" />
                    <Separator />
                    <MenuItem Header="About SlimViewer" Command="{Binding Commands.ShowAbout}" />
                </MenuItem>
            </Menu>
            
            <Button Grid.Column="2" Content="Remove from List" Command="{Binding Commands.Clear}"
                    IsEnabled="{Binding Path=IsImageActive}" Padding="5,2"
                    ToolTip="Remove the current image from the viewer's list (does not delete the file)" />

            <StackPanel Grid.Column="4" Orientation="Horizontal" VerticalAlignment="Center">
                <Label Content="File Count:" VerticalAlignment="Center" FontWeight="Bold" />
                <Label Content="{Binding Path=Count}" VerticalAlignment="Center" Margin="0,0,10,0"
                       ToolTip="Total number of images in the current list" />
                <Images:ColorPickerMenu x:Name="ColorPick" ColorChangedCommand="{Binding Commands.ColorChanged}"
                                        ToolTip="Select background color" />
            </StackPanel>

            <Slider Grid.Column="6" Minimum="0.1" Maximum="5.0"
                    Value="{Binding ZoomScale, ElementName=ImageControl, Mode=TwoWay}" VerticalAlignment="Center"
                    IsEnabled="{Binding Path=IsImageActive}" ToolTip="Adjust zoom level" />
        </Grid>

        <Border Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3" BorderBrush="LightGray" BorderThickness="0,1,0,1"
                Background="#F5F5F5" Padding="2">
            <slimControls:DrawingToolBarControl
                HorizontalAlignment="Left"
                ToolState="{Binding DataContext.MyDrawingState, RelativeSource={RelativeSource AncestorType=Window}}"
                ToolChangedCommand="{Binding DataContext.Commands.ToolChangedCommand, RelativeSource={RelativeSource AncestorType=Window}}" />
        </Border>

        <GridSplitter Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3" Height="5" HorizontalAlignment="Stretch"
                      VerticalAlignment="Center" Background="Gray" />

        <Grid Grid.Row="3" Grid.Column="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="40" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="40" />
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0" Content="←" Command="{Binding Commands.Previous}"
                    Visibility="{Binding LeftButtonVisibility}" VerticalAlignment="Center" Height="50" Opacity="0.5"
                    ToolTip="Previous Image (Left Arrow)" />

            <Images:ImageZoom Grid.Column="1" x:Name="ImageControl" IsTabStop="True"
                              ItemsSource="{Binding Bmp}" ImageGifPath="{Binding GifPath}"
                              SelectionTool="{Binding ImageZoomTool}"
                              SelectedFrameCommand="{Binding Commands.SelectedFrame}"
                              SelectedPointCommand="{Binding Commands.SelectedPoint}" />

            <Button Grid.Column="2" Content="→" Command="{Binding Commands.Next}"
                    Visibility="{Binding RightButtonVisibility}" VerticalAlignment="Center" Height="50" Opacity="0.5"
                    ToolTip="Next Image (Right Arrow)" />
        </Grid>

        <GridSplitter Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="3" Height="5" HorizontalAlignment="Stretch"
                      VerticalAlignment="Center" Background="Gray" Visibility="{Binding ThumbnailVisibility}" />

        <Grid Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="3" Visibility="{Binding ThumbnailVisibility}">
            <Grid.RowDefinitions>
                <RowDefinition Height="25" />
                <RowDefinition Height="5" />
                <RowDefinition Height="30" />
                <RowDefinition Height="5" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="25" />
                <ColumnDefinition Width="25" />
                <ColumnDefinition />
                <ColumnDefinition Width="80" />
                <ColumnDefinition Width="10" />
                <ColumnDefinition Width="80" />
                <ColumnDefinition Width="5" />
            </Grid.ColumnDefinitions>

            <Button Content="D" Grid.Row="0" Grid.Column="0" Command="{Binding Commands.Delete}"
                    IsEnabled="{Binding Path=IsImageActive}" ToolTip="Delete file from disk (Del)" />
            <Button Content="//" Grid.Row="0" Grid.Column="1" Command="{Binding Commands.Explorer}"
                    IsEnabled="{Binding Path=IsImageActive}" ToolTip="Open file location in Windows Explorer" />

            <TextBox Grid.Row="0" Grid.Column="2" Grid.ColumnSpan="4" Text="{Binding Path=Information}"
                     TextWrapping="NoWrap" Focusable="True" ScrollViewer.HorizontalScrollBarVisibility="Auto"
                     IsReadOnly="True" ToolTip="Image Information" />

            <Image Grid.Row="2" Grid.Column="0" Source="{Binding StatusImage}" ToolTip="Current application status" />
            <Button Content="R" Grid.Row="2" Grid.Column="1" Command="{Binding Commands.Rename}"
                    IsEnabled="{Binding Path=IsImageActive}" ToolTip="Rename current image" />

            <TextBox Grid.Row="2" Grid.Column="2"
                     Text="{Binding Path=FileName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     TextWrapping="Wrap" ToolTip="File Name (Press Enter to rename)">
                <TextBox.InputBindings>
                    <KeyBinding Command="{Binding Commands.Rename}" Key="Enter" />
                </TextBox.InputBindings>
            </TextBox>

            <Button Content="Move" Grid.Row="2" Grid.Column="3" Command="{Binding Commands.Move}"
                    IsEnabled="{Binding Path=IsImageActive}" ToolTip="Move current image to another folder" />
            <Button Content="Move All" Grid.Row="2" Grid.Column="5" Command="{Binding Commands.MoveAll}"
                    IsEnabled="{Binding Path=IsImageActive}" ToolTip="Move all images in list to another folder" />

            <Images:Thumbnails Name="Thumbnail" Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="6"
                               ItemsSource="{Binding Observer}" ThumbCellSize="100" ThumbHeight="1"
                               SelectBox="True" IsCheckBoxSelected="False"
                               ImageClickedCommand="{Binding Commands.ThumbImageClicked}"
                               ImageLoadedCommand="{Binding Commands.ImageLoaded}" />
        </Grid>

    </Grid>

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Themes/Generic.xaml" />
                <ResourceDictionary />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>
</Window>